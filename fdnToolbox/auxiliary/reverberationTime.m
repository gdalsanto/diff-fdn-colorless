function [reverberationTimeEarly, reverberationTimeLate, F0, powerSpectrum, edr] = reverberationTime(h, fs)
% reverberationTime = calculate the reverberation time for impulse response h in seconds (according to fs)
%
% Based on Antsalo, P., Mäkivirta, A., Välimäki, V., Peltonen, T.,
% Karjalainen, M. (2001). Estimation of Modal Decay Parameters from Noisy
% Response Measurements Audio Engineering Society Convention 110 
%
% Löllmann, H., Vary, P. (2011). Estimation of the frequency dependent
% reverberation time by means of warped filter-banks International
% Conference on Acoustics, Speech and Signal Processing (ICASSP)
% https://dx.doi.org/10.1109/icassp.2011.5946402
%
% Syntax:
% [reverberationTimeEarly, reverberationTimeLate, F0, powerSpectrum, edr] =
% reverberationTime(h, fs)
%
% Inputs:
%    h - Impulse response
%    fs - Sampling frequency
%
% Outputs:
%    reverberationTimeEarly - RT60 in [s] estimated in BEGIN to MAX - 10dB
%    reverberationTimeLate - RT60 in [s] estimated in MAX - 10dB to END
%    F0 - centre frequency of the octave bands
%
% Example:
%    [reverberationTimeEarly, reverberationTimeLate, F0] = reverberationTime( randn(100000,1).*exp( -(1:100000)'/1000 ), 48000);
%
% Other m-files required: none
% Subfunctions: none
% MAT-files required: none
%
% See also: 
% Author: Dr.-Ing. Sebastian Jiro Schlecht,
% Aalto University, Finland
% email address: sebastian.schlecht@aalto.fi
% Website: sebastianjiroschlecht.com
% 17. January 2020; Last revision: 17. January 2020

%% Filter in octave bands and compute EDR
[bandH, F0] = filterOctaveBands(h, 1, 8, fs);
edr = EDC(bandH);
edr = bsxfun(@plus, edr, size(F0,2):-1:1);
time = (1:length(edr))';
numBands = size(edr,2);
order = 1;
pEarly = zeros(order+1, numBands);
pLate = zeros(order+1, numBands);
tEarlyLate = zeros(1,numBands);

%% Linear fit to EDR
for it=1:numBands
    m = max(edr(:,it));
    t = find(edr(:,it) < m - 10,1,'first');
    tt = find(edr(:,it) < m - 60,1,'first');
    if isempty(t) t = round(length(edr)/2); end
    if isempty(tt) tt = length(edr); end
    pEarly(:,it) = polyfit(time(1:t), edr(1:t,it), 1);
%     pLate(:,it) = polyfit(time(t:tt), edr(t:tt,it), 1);
    
    coeffs=decay2_fit(edr(t:tt,it) - edr(t,it),[],[]);
    pLate(1,it) = coeffs(2);
    
    tEarlyLate(:,it) = t;
end
reverberationTimeEarly = -60 ./ pEarly(1,:) / fs;
reverberationTimeLate = -60 ./ pLate(1,:) / fs;

bandwidthEnergyCompensation = linspace(0,20,numBands);
powerSpectrum = ((edr(1,:) ) ./ reverberationTimeLate - bandwidthEnergyCompensation); 



function [y, F0] = filterOctaveBands(x, bandsPerOctave, filterOrder, fs)
% calculates warped octave filter banks
switch 'useToolbox'
    case 'useToolbox'
        % get valied frequencies
        BandsPerOctave = 1;
        N = 6;           % Filter Order
        F0 = 1000;       % Center Frequency (Hz)
        Fs = fs;         % Sampling Frequency (Hz)
        f = fdesign.octave(BandsPerOctave,'Class 1','N,F0',N,F0,Fs);
        
        % create bandpass filters
        f.BandsPerOctave = bandsPerOctave;
        f.FilterOrder = filterOrder;
        F0 = validfrequencies(f);
        Nfc = length(F0);
        
        Hd3 = dfilt.df2sos;
        for i=1:Nfc,
            f.F0 = F0(i);
            Hd3(i) = design(f,'butter');
        end
        % printDf2SOS(Hd3)
        
    case 'usePrecalculate'
        [Hd3, F0] = getOctaveFilter();
        Nfc = length(F0);
end

Nx = length(x);
y = zeros(Nx,Nfc);
% filter signal
lam=0.7; % value of the warping coefficient
for i=1:Nfc
    x = ap_delay(x,lam);
    y(:,i) = filter(Hd3(i),x);
end


function delayed = ap_delay(sig,lambda)
% AP_DELAY - implementation of a single first order allpass filter
%
% y = ap_delay(x,lambda)
%
% filters sequence x with a first order allpass filter with
% parameter lambda.

b = [-lambda 1]';
a = [1 -lambda]';
delayed = filter(b,a,sig);

function [Hd3, F0] = getOctaveFilter()
% precalculated octave filters to avoid using DSP Toolbox
F0 = [25.118864 31.622777 39.810717 50.118723 63.095734 79.432823 100.000000 125.892541 158.489319 199.526231 251.188643 316.227766 398.107171 501.187234 630.957344 794.328235 1000.000000 1258.925412 1584.893192 1995.262315 2511.886432 3162.277660 3981.071706 5011.872336 6309.573445 7943.282347 10000.000000 12589.254118 15848.931925 19952.623150];
Hd3(1) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.999666 0.999679 ;1.000000 0.000000 -1.000000 1.000000 -1.999732 0.999740 ;1.000000 0.000000 -1.000000 1.000000 -1.999256 0.999268 ;1.000000 0.000000 -1.000000 1.000000 -1.999320 0.999330 ;],[0.000379 ;0.000379 ;0.000379 ;0.000379 ;1.000000 ;]);
Hd3(2) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.999575 0.999596 ;1.000000 0.000000 -1.000000 1.000000 -1.999659 0.999673 ;1.000000 0.000000 -1.000000 1.000000 -1.999060 0.999079 ;1.000000 0.000000 -1.000000 1.000000 -1.999141 0.999157 ;],[0.000478 ;0.000478 ;0.000477 ;0.000477 ;1.000000 ;]);
Hd3(3) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.999457 0.999491 ;1.000000 0.000000 -1.000000 1.000000 -1.999567 0.999589 ;1.000000 0.000000 -1.000000 1.000000 -1.998811 0.998840 ;1.000000 0.000000 -1.000000 1.000000 -1.998914 0.998939 ;],[0.000601 ;0.000601 ;0.000601 ;0.000601 ;1.000000 ;]);
Hd3(4) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.999306 0.999359 ;1.000000 0.000000 -1.000000 1.000000 -1.999447 0.999482 ;1.000000 0.000000 -1.000000 1.000000 -1.998493 0.998540 ;1.000000 0.000000 -1.000000 1.000000 -1.998625 0.998664 ;],[0.000757 ;0.000757 ;0.000756 ;0.000756 ;1.000000 ;]);
Hd3(5) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.999109 0.999194 ;1.000000 0.000000 -1.000000 1.000000 -1.999293 0.999348 ;1.000000 0.000000 -1.000000 1.000000 -1.998088 0.998163 ;1.000000 0.000000 -1.000000 1.000000 -1.998256 0.998319 ;],[0.000953 ;0.000953 ;0.000952 ;0.000952 ;1.000000 ;]);
Hd3(6) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.998851 0.998985 ;1.000000 0.000000 -1.000000 1.000000 -1.999092 0.999180 ;1.000000 0.000000 -1.000000 1.000000 -1.997570 0.997688 ;1.000000 0.000000 -1.000000 1.000000 -1.997785 0.997884 ;],[0.001199 ;0.001199 ;0.001198 ;0.001198 ;1.000000 ;]);
Hd3(7) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.998510 0.998722 ;1.000000 0.000000 -1.000000 1.000000 -1.998829 0.998967 ;1.000000 0.000000 -1.000000 1.000000 -1.996903 0.997090 ;1.000000 0.000000 -1.000000 1.000000 -1.997180 0.997337 ;],[0.001509 ;0.001509 ;0.001508 ;0.001508 ;1.000000 ;]);
Hd3(8) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.998056 0.998392 ;1.000000 0.000000 -1.000000 1.000000 -1.998481 0.998700 ;1.000000 0.000000 -1.000000 1.000000 -1.996041 0.996337 ;1.000000 0.000000 -1.000000 1.000000 -1.996400 0.996648 ;],[0.001900 ;0.001900 ;0.001898 ;0.001898 ;1.000000 ;]);
Hd3(9) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.997444 0.997976 ;1.000000 0.000000 -1.000000 1.000000 -1.998016 0.998364 ;1.000000 0.000000 -1.000000 1.000000 -1.994922 0.995391 ;1.000000 0.000000 -1.000000 1.000000 -1.995389 0.995782 ;],[0.002392 ;0.002392 ;0.002388 ;0.002388 ;1.000000 ;]);
Hd3(10) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.996609 0.997452 ;1.000000 0.000000 -1.000000 1.000000 -1.997390 0.997940 ;1.000000 0.000000 -1.000000 1.000000 -1.993458 0.994201 ;1.000000 0.000000 -1.000000 1.000000 -1.994070 0.994693 ;],[0.003010 ;0.003010 ;0.003005 ;0.003005 ;1.000000 ;]);
Hd3(11) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.995458 0.996793 ;1.000000 0.000000 -1.000000 1.000000 -1.996535 0.997408 ;1.000000 0.000000 -1.000000 1.000000 -1.991529 0.992706 ;1.000000 0.000000 -1.000000 1.000000 -1.992337 0.993323 ;],[0.003788 ;0.003788 ;0.003781 ;0.003781 ;1.000000 ;]);
Hd3(12) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.993849 0.995965 ;1.000000 0.000000 -1.000000 1.000000 -1.995355 0.996737 ;1.000000 0.000000 -1.000000 1.000000 -1.988962 0.990826 ;1.000000 0.000000 -1.000000 1.000000 -1.990040 0.991601 ;],[0.004767 ;0.004767 ;0.004755 ;0.004755 ;1.000000 ;]);
Hd3(13) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.991572 0.994923 ;1.000000 0.000000 -1.000000 1.000000 -1.993705 0.995894 ;1.000000 0.000000 -1.000000 1.000000 -1.985514 0.988464 ;1.000000 0.000000 -1.000000 1.000000 -1.986967 0.989438 ;],[0.005999 ;0.005999 ;0.005980 ;0.005980 ;1.000000 ;]);
Hd3(14) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.988307 0.993613 ;1.000000 0.000000 -1.000000 1.000000 -1.991365 0.994834 ;1.000000 0.000000 -1.000000 1.000000 -1.980831 0.985499 ;1.000000 0.000000 -1.000000 1.000000 -1.982810 0.986721 ;],[0.007548 ;0.007548 ;0.007517 ;0.007517 ;1.000000 ;]);
Hd3(15) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.983566 0.991967 ;1.000000 0.000000 -1.000000 1.000000 -1.988007 0.993500 ;1.000000 0.000000 -1.000000 1.000000 -1.974397 0.981779 ;1.000000 0.000000 -1.000000 1.000000 -1.977124 0.983311 ;],[0.009495 ;0.009495 ;0.009447 ;0.009447 ;1.000000 ;]);
Hd3(16) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.976603 0.989899 ;1.000000 0.000000 -1.000000 1.000000 -1.983127 0.991823 ;1.000000 0.000000 -1.000000 1.000000 -1.965447 0.977116 ;1.000000 0.000000 -1.000000 1.000000 -1.969252 0.979033 ;],[0.011942 ;0.011942 ;0.011866 ;0.011866 ;1.000000 ;]);
Hd3(17) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.966272 0.987303 ;1.000000 0.000000 -1.000000 1.000000 -1.975954 0.989714 ;1.000000 0.000000 -1.000000 1.000000 -1.952849 0.971278 ;1.000000 0.000000 -1.000000 1.000000 -1.958220 0.973673 ;],[0.015017 ;0.015017 ;0.014897 ;0.014897 ;1.000000 ;]);
Hd3(18) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.950805 0.984048 ;1.000000 0.000000 -1.000000 1.000000 -1.965299 0.987064 ;1.000000 0.000000 -1.000000 1.000000 -1.934904 0.963979 ;1.000000 0.000000 -1.000000 1.000000 -1.942573 0.966963 ;],[0.018876 ;0.018876 ;0.018688 ;0.018688 ;1.000000 ;]);
Hd3(19) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.927479 0.979972 ;1.000000 0.000000 -1.000000 1.000000 -1.949332 0.983733 ;1.000000 0.000000 -1.000000 1.000000 -1.909068 0.954871 ;1.000000 0.000000 -1.000000 1.000000 -1.920128 0.958575 ;],[0.023719 ;0.023719 ;0.023423 ;0.023423 ;1.000000 ;]);
Hd3(20) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.892108 0.974875 ;1.000000 0.000000 -1.000000 1.000000 -1.925232 0.979548 ;1.000000 0.000000 -1.000000 1.000000 -1.871518 0.943533 ;1.000000 0.000000 -1.000000 1.000000 -1.887606 0.948104 ;],[0.029790 ;0.029790 ;0.029326 ;0.029326 ;1.000000 ;]);
Hd3(21) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.838299 0.968521 ;1.000000 0.000000 -1.000000 1.000000 -1.888660 0.974287 ;1.000000 0.000000 -1.000000 1.000000 -1.816543 0.929459 ;1.000000 0.000000 -1.000000 1.000000 -1.840094 0.935058 ;],[0.037391 ;0.037391 ;0.036667 ;0.036667 ;1.000000 ;]);
Hd3(22) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.756398 0.960628 ;1.000000 0.000000 -1.000000 1.000000 -1.832986 0.967670 ;1.000000 0.000000 -1.000000 1.000000 -1.735691 0.912061 ;1.000000 0.000000 -1.000000 1.000000 -1.770277 0.918836 ;],[0.046896 ;0.046896 ;0.045770 ;0.045770 ;1.000000 ;]);
Hd3(23) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.632107 0.950879 ;1.000000 0.000000 -1.000000 1.000000 -1.748204 0.959334 ;1.000000 0.000000 -1.000000 1.000000 -1.616672 0.890663 ;1.000000 0.000000 -1.000000 1.000000 -1.667427 0.898707 ;],[0.058759 ;0.058759 ;0.057016 ;0.057016 ;1.000000 ;]);
Hd3(24) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.444968 0.938937 ;1.000000 0.000000 -1.000000 1.000000 -1.619514 0.948804 ;1.000000 0.000000 -1.000000 1.000000 -1.442198 0.864523 ;1.000000 0.000000 -1.000000 1.000000 -1.516225 0.873783 ;],[0.073533 ;0.073533 ;0.070850 ;0.070850 ;1.000000 ;]);
Hd3(25) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -1.167446 0.924509 ;1.000000 0.000000 -1.000000 1.000000 -1.425832 0.935423 ;1.000000 0.000000 -1.000000 1.000000 -1.295813 0.842966 ;1.000000 0.000000 -1.000000 1.000000 -1.189318 0.832885 ;],[0.091881 ;0.091881 ;0.087781 ;0.087781 ;1.000000 ;]);
Hd3(26) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -0.766714 0.907472 ;1.000000 0.000000 -1.000000 1.000000 -1.139082 0.918236 ;1.000000 0.000000 -1.000000 1.000000 -0.980288 0.804856 ;1.000000 0.000000 -1.000000 1.000000 -0.830843 0.795094 ;],[0.114588 ;0.114588 ;0.108378 ;0.108378 ;1.000000 ;]);
Hd3(27) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -0.214033 0.888228 ;1.000000 0.000000 -1.000000 1.000000 -0.726809 0.895689 ;1.000000 0.000000 -1.000000 1.000000 -0.342429 0.750882 ;1.000000 0.000000 -1.000000 1.000000 -0.543571 0.757516 ;],[0.142567 ;0.142567 ;0.133260 ;0.133260 ;1.000000 ;]);
Hd3(28) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 -0.164161 0.864780 ;1.000000 0.000000 -1.000000 1.000000 0.488943 0.868707 ;1.000000 0.000000 -1.000000 1.000000 0.024999 0.697771 ;1.000000 0.000000 -1.000000 1.000000 0.277996 0.701200 ;],[0.176857 ;0.176857 ;0.163093 ;0.163093 ;1.000000 ;]);
Hd3(29) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 0.531633 0.817593 ;1.000000 0.000000 -1.000000 1.000000 1.255580 0.856486 ;1.000000 0.000000 -1.000000 1.000000 0.970663 0.651964 ;1.000000 0.000000 -1.000000 1.000000 0.682135 0.617995 ;],[0.218610 ;0.218610 ;0.198576 ;0.198576 ;1.000000 ;]);
Hd3(30) = dfilt.df2sos([1.000000 0.000000 -1.000000 1.000000 1.202687 0.712485 ;1.000000 0.000000 -1.000000 1.000000 1.858291 0.903136 ;1.000000 0.000000 -1.000000 1.000000 1.612292 0.683163 ;1.000000 0.000000 -1.000000 1.000000 1.199895 0.457530 ;],[0.269064 ;0.269064 ;0.240456 ;0.240456 ;1.000000 ;]);

function printDf2SOS(Hd)
% script to create function getOctaveFilter
len = size(Hd,2);
for it = 1:len
    fprintf(['Hd3(' num2str(it) ') = dfilt.df2sos(']);
    printMatSyntax( Hd(it).sosMatrix );
    fprintf(',');
    printMatSyntax( Hd(it).ScaleValues );
    fprintf(');\n');
end